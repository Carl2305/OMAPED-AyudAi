<!-- Main Content -->
<main class="main-content">
  <!-- Title Card -->
  <div class="title-card">
    <h2>Clasificación y Priorización de Beneficiarios</h2>
    <p>
      Gestione y priorice los beneficiarios registrados en el sistema OMAPED.
    </p>
  </div>

  <!-- Table Card -->
  <div class="table-card">
    <!-- Table Header with Controls -->
    <div class="table-header">
      <div class="table-info">
        <h3>Lista de Beneficiarios</h3>
        <span class="total-count">{{ totalCount }} registros en total</span>
      </div>

      <!-- Search Input -->
      <div class="search-control">
        <div class="search-input-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Buscar por número de documento..."
            [(ngModel)]="searchDocument"
            (input)="onSearchChange()"
            [disabled]="isLoading"
          />
          <button 
            *ngIf="searchDocument" 
            class="clear-search-btn" 
            (click)="clearSearch()"
            type="button"
            title="Limpiar búsqueda"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="table-controls">
        <!-- Page Size Selector -->
        <div class="page-size-control">
          <label for="pageSize">Mostrar:</label>
          <select 
            id="pageSize" 
            [value]="pageSize" 
            (change)="changePageSize($event)"
            [disabled]="isLoading"
          >
            <option *ngFor="let size of pageSizeOptions" [value]="size">
              {{ size }}
            </option>
          </select>
        </div>

        <!-- Export Buttons -->
        <div class="export-controls">
          <!-- Export Current Page -->
          <button 
            class="btn-export btn-export-current"
            (click)="exportCurrentPageToExcel()"
            [disabled]="isLoading || isExporting || beneficiaries.length === 0"
            title="Exportar página actual a Excel"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            <span class="btn-text">Exportar página</span>
          </button>

          <!-- Export All -->
          <button 
            class="btn-export btn-export-all"
            (click)="exportAllToExcel()"
            [disabled]="isLoading || isExporting || totalCount === 0"
            title="Exportar todos los beneficiarios a Excel"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" *ngIf="!isExporting">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <div class="spinner-small" *ngIf="isExporting"></div>
            <span class="btn-text">{{ isExporting ? 'Exportando...' : 'Exportar todo' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando beneficiarios...</p>
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="errorMessage && !isLoading">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>{{ errorMessage }}</span>
      <button class="retry-btn" (click)="loadBeneficiaries()">Reintentar</button>
    </div>

    <!-- Table Container -->
    <div class="table-container" *ngIf="!isLoading && !errorMessage">
      <!-- Empty State -->
      <div class="empty-state" *ngIf="beneficiaries.length === 0">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 11l3 3L22 4"></path>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        <h3>No hay beneficiarios registrados</h3>
        <p>Aún no se han encontrado beneficiarios en el sistema.</p>
      </div>

      <!-- Table -->
      <table class="beneficiaries-table" *ngIf="beneficiaries.length > 0">
        <thead>
          <tr>
            <th>
              <button class="sort-header" (click)="sortBy('tipoDocumento')" type="button">
                <span>Tipo Doc.</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
                     [class.active]="sortColumn === 'tipoDocumento'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('numeroDocumento')" type="button">
                <span>N° Documento</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'numeroDocumento'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('nombreCompleto')" type="button">
                <span>Beneficiario</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'nombreCompleto'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('tipoDiscapacidad')" type="button">
                <span>Tipo Discapacidad</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'tipoDiscapacidad'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('edad')" type="button">
                <span>Edad</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'edad'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('nivelRiesgo')" type="button">
                <span>Nivel de Riesgo</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'nivelRiesgo'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('scoreModelo')" type="button">
                <span>Score ML</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'scoreModelo'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('rangoIngresos')" type="button">
                <span>Ingresos (S/)</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'rangoIngresos'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th>
              <button class="sort-header" (click)="sortBy('serviciosBasicos')" type="button">
                <span>Servicios Básicos</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     [class.active]="sortColumn === 'serviciosBasicos'" [class.asc]="sortDirection === 'asc'" [class.desc]="sortDirection === 'desc'">
                  <path d="m7 15 5 5 5-5"></path>
                  <path d="m7 9 5-5 5 5"></path>
                </svg>
              </button>
            </th>
            <th class="actions-column">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let beneficiary of beneficiaries">
            <td>
              <span class="doc-type-badge">{{ beneficiary.tipoDocumento }}</span>
            </td>
            <td>
              <span class="doc-number">{{ beneficiary.numeroDocumento }}</span>
            </td>
            <td>
              <span class="beneficiary-name">{{ beneficiary.nombreCompleto }}</span>
            </td>
            <td>
              <span class="disability-badge">{{ beneficiary.tipoDiscapacidad }}</span>
            </td>
            <td>
              <span class="age">{{ beneficiary.edad }} años</span>
            </td>
            <td>
              <span class="risk-badge" [ngClass]="getRiskClass(beneficiary.nivelRiesgo)">
                {{ beneficiary.nivelRiesgo || '-' }}
              </span>
            </td>
            <td>
              <span class="score">{{ beneficiary.scoreModelo ? beneficiary.scoreModelo.toFixed(2) : '-' }}</span>
            </td>
            <td>
              <span class="income-range">{{ beneficiary.rangoIngresos || 0 }}</span>
            </td>
            <td>
              <span class="services" *ngIf="beneficiary.serviciosBasicos; else noServices">
                {{ beneficiary.serviciosBasicos }}
              </span>
              <ng-template #noServices>
                <span class="no-data">-</span>
              </ng-template>
            </td>
            <td class="actions-column">
              <div class="action-buttons">
                <button 
                  class="btn-action btn-shap" 
                  title="Ver explicación SHAP"
                  type="button"
                  (click)="openShapExplanation(beneficiary)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
                <button 
                  class="btn-action btn-history" 
                  title="Ver bitácora de cambios"
                  type="button"
                  (click)="openAuditHistory(beneficiary)"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="!isLoading && beneficiaries.length > 0">
      <div class="pagination-info">
        <span>Mostrando {{ getDisplayRange() }}</span>
      </div>

      <div class="pagination-controls">
        <!-- Previous Button -->
        <button 
          class="pagination-btn"
          [disabled]="!hasPreviousPage"
          (click)="previousPage()"
          type="button"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Anterior
        </button>

        <!-- Page Numbers -->
        <div class="page-numbers">
          <!-- First Page -->
          <button 
            *ngIf="getPageNumbers()[0] > 1"
            class="page-number"
            (click)="goToPage(1)"
            type="button"
          >
            1
          </button>
          
          <!-- Ellipsis Start -->
          <span class="ellipsis" *ngIf="getPageNumbers()[0] > 2">...</span>
          
          <!-- Page Buttons -->
          <button 
            *ngFor="let page of getPageNumbers()"
            class="page-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
            type="button"
          >
            {{ page }}
          </button>
          
          <!-- Ellipsis End -->
          <span class="ellipsis" *ngIf="getPageNumbers()[getPageNumbers().length - 1] < totalPages - 1">...</span>
          
          <!-- Last Page -->
          <button 
            *ngIf="getPageNumbers()[getPageNumbers().length - 1] < totalPages"
            class="page-number"
            (click)="goToPage(totalPages)"
            type="button"
          >
            {{ totalPages }}
          </button>
        </div>

        <!-- Next Button -->
        <button 
          class="pagination-btn"
          [disabled]="!hasNextPage"
          (click)="nextPage()"
          type="button"
        >
          Siguiente
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
    </div>
  </div>
</main>

<!-- Modal de Bitácora de Cambios -->
<app-audit-history-modal
  *ngIf="showAuditModal"
  [beneficiaryId]="selectedBeneficiaryId!"
  [beneficiaryName]="selectedBeneficiaryName"
  (closeModal)="closeAuditModal()"
></app-audit-history-modal>

<!-- Modal de Explicación SHAP -->
<app-shap-explanation-modal
  *ngIf="showShapModal"
  [beneficiarioId]="shapBeneficiaryId!"
  [beneficiarioNombre]="shapBeneficiaryName"
  (closeModal)="closeShapModal()"
></app-shap-explanation-modal>
